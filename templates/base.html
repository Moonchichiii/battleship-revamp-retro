<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, viewport-fit=cover"
        />

        <!-- Meta Tags -->
        <meta
            name="description"
            content="{% block description %}Play the classic Battleship game online. Modern web implementation with FastAPI and HTMX. Challenge yourself and compete for top scores!{% endblock %}"
        />
        <meta
            name="keywords"
            content="battleship game, online battleship, web game, strategy game, FastAPI, HTMX"
        />
        <meta name="author" content="Battleship Revamp" />
        <meta name="robots" content="index, follow" />
        <link rel="canonical" href="{{ request.base_url }}" />

        <!-- Open Graph -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content="{{ request.base_url }}" />
        <meta
            property="og:title"
            content="{% block og_title %}{{ self.title() }}{% endblock %}"
        />
        <meta
            property="og:description"
            content="{% block og_description %}{{ self.description() }}{% endblock %}"
        />
        <meta
            property="og:image"
            content="{{ url_for('static', path='assets/og-image.png') }}"
        />
        <meta property="og:site_name" content="Battleship Revamp" />

        <!-- Favicon -->
        <link
            rel="icon"
            type="image/svg+xml"
            href="{{ url_for('static', path='assets/favicon.svg') }}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="{{ url_for('static', path='assets/favicon-32x32.png') }}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="{{ url_for('static', path='assets/favicon-16x16.png') }}"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ url_for('static', path='assets/apple-touch-icon.png') }}"
        />
        <link
            rel="mask-icon"
            href="{{ url_for('static', path='assets/favicon.svg') }}"
            color="#00ff66"
        />
        <meta name="theme-color" content="#00ff66" />
        <meta name="msapplication-TileColor" content="#00ff66" />

        <!-- Structured Data -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebApplication",
                "name": "Battleship Revamp",
                "description": "Modern online Battleship game built with FastAPI and HTMX",
                "url": "{{ request.base_url }}",
                "applicationCategory": "Game",
                "operatingSystem": "Web Browser",
                "offers": {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "USD"
                },
                "author": {
                    "@type": "Organization",
                    "name": "Battleship Revamp"
                }
            }
        </script>

        <title>
            {% block title %}Battleship Revamp - Play Online Battleship Game{%
            endblock %}
        </title>

        <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>

        <link
            rel="stylesheet"
            href="{{ url_for('static', path='css/retro.css') }}"
        />
        {% block extra_css %}{% endblock %}
    </head>
    <body>
        <!-- Enhanced Skip Links -->
        <div class="skip-links">
            <a class="skip-link" href="#main">Skip to main content</a>
            <a class="skip-link" href="#primary-nav">Skip to navigation</a>
        </div>
        <!-- Mobile Navigation Toggle -->
        <button
            class="mobile-nav-toggle"
            id="mobile-nav-toggle"
            aria-label="Toggle navigation menu"
            aria-expanded="false"
            aria-controls="primary-nav"
        >
            <span id="nav-icon">☰</span>
        </button>

        <!-- Mobile Navigation Overlay -->
        <div class="nav-overlay" id="nav-overlay" aria-hidden="true"></div>

        <header class="site-header" role="banner">
            <div class="container">
                <h1 class="brand">Battleship Revamp</h1>
                <p class="tagline">
                    A modern take on Battleship using FastAPI and HTMX.
                </p>
                <div
                    id="auth-header"
                    class="container"
                    style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 0.5rem;
                    "
                >
                    {% if current_user %}
                    <span
                        >Welcome, {{ current_user.display_name or
                        current_user.username }}!</span
                    >
                    <button
                        class="btn btn-secondary"
                        hx-post="/auth/logout"
                        hx-target="#main"
                        hx-swap="innerHTML"
                        hx-push-url="true"
                    >
                        Logout
                    </button>
                    {% else %}
                    <span>Guest</span>
                    {% endif %}
                </div>
            </div>
        </header>

        <nav
            id="primary-nav"
            class="nav"
            aria-label="Primary navigation"
            role="navigation"
        >
            <div class="container">
                <div
                    class="tabs"
                    id="primary-tabs"
                    role="tablist"
                    aria-orientation="horizontal"
                    aria-label="Main navigation tabs"
                >
                    <!-- Home -->
                    <button
                        id="tab-home"
                        type="button"
                        class="tab {% if active_tab=='home' %}is-active{% endif %}"
                        role="tab"
                        aria-selected="{% if active_tab=='home' %}true{% else %}false{% endif %}"
                        aria-controls="main"
                        tabindex="{% if active_tab=='home' %}0{% else %}-1{% endif %}"
                        hx-get="{{ url_for('home') }}"
                        hx-target="#main"
                        hx-swap="innerHTML"
                        hx-push-url="true"
                    >
                        Home {% if active_tab=='home' %}<span
                            class="visually-hidden"
                            >(current)</span
                        >{% endif %}
                    </button>

                    <!-- Game -->
                    {% if current_user %}
                    <button
                        id="tab-ai"
                        type="button"
                        class="tab {% if active_tab=='ai' %}is-active{% endif %}"
                        role="tab"
                        aria-selected="{% if active_tab=='ai' %}true{% else %}false{% endif %}"
                        aria-controls="main"
                        tabindex="{% if active_tab=='ai' %}0{% else %}-1{% endif %}"
                        hx-get="{{ url_for('ai_lobby') if url_for else '/ai' }}"
                        hx-target="#main"
                        hx-swap="innerHTML"
                        hx-push-url="true"
                    >
                        AI Opponents {% if active_tab=='ai' %}<span
                            class="visually-hidden"
                            >(current)</span
                        >{% endif %}
                    </button>
                    {% endif %}

                    <button
                        id="tab-game"
                        type="button"
                        class="tab {% if active_tab=='game' %}is-active{% endif %}"
                        role="tab"
                        aria-selected="{% if active_tab=='game' %}true{% else %}false{% endif %}"
                        aria-controls="main"
                        tabindex="{% if active_tab=='game' %}0{% else %}-1{% endif %}"
                        hx-get="{{ url_for('game') }}"
                        hx-target="#main"
                        hx-swap="innerHTML"
                        hx-push-url="true"
                    >
                        Play Game {% if active_tab=='game' %}<span
                            class="visually-hidden"
                            >(current)</span
                        >{% endif %}
                    </button>

                    <!-- Scores -->
                    <button
                        id="tab-scores"
                        type="button"
                        class="tab {% if active_tab=='scores' %}is-active{% endif %}"
                        role="tab"
                        aria-selected="{% if active_tab=='scores' %}true{% else %}false{% endif %}"
                        aria-controls="main"
                        tabindex="{% if active_tab=='scores' %}0{% else %}-1{% endif %}"
                        hx-get="{{ url_for('scores') }}"
                        hx-target="#main"
                        hx-swap="innerHTML"
                        hx-push-url="true"
                    >
                        Top Scores {% if active_tab=='scores' %}<span
                            class="visually-hidden"
                            >(current)</span
                        >{% endif %}
                    </button>

                    <span id="guest-nav">
                        {% if not current_user %}
                        <button
                            id="tab-signin"
                            type="button"
                            class="tab {% if active_tab=='signin' %}is-active{% endif %}"
                            role="tab"
                            aria-selected="{% if active_tab=='signin' %}true{% else %}false{% endif %}"
                            aria-controls="main"
                            tabindex="{% if active_tab=='signin' %}0{% else %}-1{% endif %}"
                            hx-get="{{ url_for('signin') }}"
                            hx-target="#main"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                        >
                            Sign In {% if active_tab=='signin' %}<span
                                class="visually-hidden"
                                >(current)</span
                            >{% endif %}
                        </button>

                        <button
                            id="tab-signup"
                            type="button"
                            class="tab {% if active_tab=='signup' %}is-active{% endif %}"
                            role="tab"
                            aria-selected="{% if active_tab=='signup' %}true{% else %}false{% endif %}"
                            aria-controls="main"
                            tabindex="{% if active_tab=='signup' %}0{% else %}-1{% endif %}"
                            hx-get="{{ url_for('signup') }}"
                            hx-target="#main"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                        >
                            Register {% if active_tab=='signup' %}<span
                                class="visually-hidden"
                                >(current)</span
                            >{% endif %}
                        </button>
                        {% endif %}
                    </span>
                </div>
            </div>
        </nav>

        <main id="main" class="container" role="main" aria-live="polite">
            {% block content %}{% endblock %}
        </main>

        <footer class="site-footer" role="contentinfo">
            <div class="container">
                <p>
                    &copy; 2025 Battleship Revamp — Built with
                    <a
                        href="https://fastapi.tiangolo.com/"
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="FastAPI framework (opens in new window)"
                        >FastAPI</a
                    >
                    &amp;
                    <a
                        href="https://htmx.org/"
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="HTMX library (opens in new window)"
                        >HTMX</a
                    >
                    • <a href="#main" aria-label="Back to top">↑ Top</a>
                </p>
            </div>
        </footer>

        <script>
            // Robust tab highlighting: compare each tab's hx-get to current path.
            (function () {
                function updateTabs() {
                    const here = new URL(location.href);
                    document.querySelectorAll(".tabs .tab").forEach((tab) => {
                        const hx = tab.getAttribute("hx-get");
                        if (!hx) return;
                        const tabUrl = new URL(hx, location.origin);
                        const isActive = tabUrl.pathname === here.pathname;
                        tab.classList.toggle("is-active", isActive);
                        tab.setAttribute(
                            "aria-selected",
                            isActive ? "true" : "false"
                        );
                        tab.setAttribute("tabindex", isActive ? "0" : "-1");
                        const sr = tab.querySelector(".visually-hidden");
                        if (sr) sr.textContent = isActive ? " (current)" : "";
                    });
                }

                document.addEventListener("DOMContentLoaded", updateTabs);
                document.addEventListener("htmx:afterSwap", updateTabs);

                // Optional: basic error announcement for HTMX failures
                document.addEventListener("htmx:responseError", function () {
                    const el = document.createElement("div");
                    el.setAttribute("role", "alert");
                    el.className = "visually-hidden";
                    el.textContent = "Navigation error. Please try again.";
                    document.body.appendChild(el);
                    setTimeout(() => {
                        if (document.body.contains(el))
                            document.body.removeChild(el);
                    }, 3000);
                });
            })();
        </script>
        {% block extra_js %}{% endblock %}
    </body>
</html>
